<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html"/>
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html"/>
<link rel="import" href="bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html"/>
<link rel="import" href="bower_components/paper-input/paper-input.html"/>
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">

<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">

<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <bde-repository-browser></bde-repository-browser>

@group Seed Elements
@element bde-repository-browser
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="bde-repository-browser">

    <template>

        <style>
            :host {
                display: block;
                box-sizing: border-box;
                font-family: 'Roboto Mono', 'Consolas', 'Menlo', monospace;
            }

            :host #addBtn {
                float: right;
                margin: 25px;
                background-color: #787f7c;
            }

            :host paper-dialog {
                width: 45vw;
            }

            :host .item {
                background-color: #fff;
                margin: 2px;
                padding: 5px;
                border: 1px solid #999;
                border-radius: 3px;
            }

            :host .addItem {
                position: absolute;
                right: 10px;
            }
        </style>

        <iron-ajax
                auto
                id="webblebase"
                url="{{url}}"
                handle-as="json"
                on-response="handleResponse">
        </iron-ajax>

        <paper-fab id="addBtn" icon="add" on-tap="toggleDialog"></paper-fab>

        <paper-dialog id="searchDialog" with-backdrop exit-animation="fade-out-animation">

            <paper-input id="baseSearch" class="dialogHeader" label="Search components in Base" type="search"
                         placeholder="Search for name..." on-keyup="handleKeyup">
            </paper-input>

            <paper-dialog-scrollable>

                <template is="dom-repeat" items="{{filtered}}" as="webble">

                    <paper-item id="{{index}}" class="item" flex on-focus="openItem">
                        <h4>{{webble.name}}</h4>
                        <div>{{webble.description}}</div>
                        <!-- TODO (ene): make description as a collapsible element-->
                        <!--<paper-icon-button class="addItem" icon="add" on-tap="fireEvent"></paper-icon-button>-->
                    </paper-item>

                </template>
            </paper-dialog-scrollable>

        </paper-dialog>

    </template>

</dom-module>

<script>

    Polymer({

        is : 'bde-repository-browser',

        properties : {
            url : {notify : true},
            /**
             * Array for the filtered ajax response
             *
             * @property filtered
             * @type array
             */
            filtered : {
                type : Array,
                value : function(){
                    return [];
                }
            },
            /**
             * Array for the ajax response
             *
             * @property response
             * @type array
             */
            response : {
                type : Array,
                value : function(){
                    return [];
                },
                notify : true
            },

        },

        toggleDialog : function(){
            this.$.searchDialog.toggle();
        },

        openItem : function(evt){
            var itemIndex = evt.target.id

            var itemObj = ( this.filtered )
                    ? this.filtered[itemIndex]
                    : this.response[itemIndex];
        },

        /**
         * Handles the input of a search term in the input field and returns the filtered array with the
         * expression in the input.
         *
         * @method handleKeyup
         * @param evt keyup-event
         */
        handleKeyup : function(evt){
            var searchTerm = evt.target.value;
            this.filtered = this.response.filter(function(item){
                return item.name.match(new RegExp(evt.target.value));
            });
        },

        /**
         * Handles the response of the ajax call, i.e. filtering.
         *
         * @method response
         * @param evt
         * @param data
         */
        handleResponse : function(evt, data){
            // Show only webcomponents or webapps
            this.response = this.filtered = data.response.filter(function(item){
                return item.webpackageType.match(/webcomponent/) && item.name.match(/^(?!bc|demo|bde)/);
            });
        },
        // TODO (ene): use couchDB functionality for filtering certain document-attributes, like modelVersion // see JIRA for open task
        // TODO (ene): filter the modelVersions and use them as dropdown selector

        fireEvent : function(evt){
            console.log('>> addItemButton Tap <<')
        }

    });

</script>
